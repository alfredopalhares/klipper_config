
# Filament Change. This macro will pause the printer, move the
# tool to the change position, and retract the filament 100mm. Adjust
# the retraction settings for your own extruder. After filament has
# been changed, the print can be resumed from its previous position
# with the "RESUME" gcode.

[gcode_macro CHANGE_FILAMENT]
description: Moves the toolhead to the front and retracts filament
gcode:
    {% set X = params.X | default(50, true) | float %}
    {% set Y = params.Y | default(10, true) | float %}
    {% set E = params.E | default(-100, true) | float %}
    { action_respond_info("Change Filament Activated") }
    SAVE_GCODE_STATE NAME=CHANGE_FILAMENT_state
    PAUSE
    { action_respond_info("Increasing idle timeout") }
    SET_IDLE_TIMEOUT TIMEOUT=86400 # increase idle timeout for a day
    { action_respond_info("Disabled filament sensor, do not forget to re-enable") }
    SET_FILAMENT_SENSOR SENSOR=btt_smart ENABLE=0
    G91
    G1 E-.8 F2700  # Just to avoid stringing
    G90
    G1 X{X} Y{Y} F3000
    G91
    #  G1 E{E} F1000  I think the float above always give me a positive number
    { action_respond_info("Extruding Filament") }
    G1 E-95 F100
    RESTORE_GCODE_STATE NAME=CHANGE_FILAMENT_state


